<!DOCTYPE html>
<html>
    <head>
        <title>Ranking tagpro</title>
        <meta charset="utf-8">
        <style type="text/css">
            @import url(https://fonts.googleapis.com/css?family=Roboto:400,100,300,500,700,900);
    
            body {
                font-family: Roboto;
            }

            #joueurs {
              padding: 0;
            }

            .joueur, .button {
                padding: 10px 20px;
                display: inline-block;
                background-color: #2d2d2d;
                color: white;
                border-radius: 20px 0px 20px 0px;
                box-shadow: 0px 1px 2px 0px rgba(0, 0, 0, .5);
                margin-right: 10px;
                cursor:pointer;
            }

            .button {
                background-color: white;
                font-weight: bold;
                color: rgb(96, 96, 96);
            }

            .button:hover {
                box-shadow: 0px 2px 3px 0px rgba(0, 0, 0, .5);
            }

            .joueur:hover {
                box-shadow: 0px 2px 3px 0px rgba(0, 0, 0, .5);
                background-color: orange;
            }

            .joueur.added {
                background: grey;
            }
        </style>
    </head>
    <body>

        <h2>Recomposer les équipes :</h2>
        <div>
            <ul id="joueurs">
                <!-- Will be completed with the list of players from the server -->
            </ul>
        </div>
        <div style="float:left">
            <p>Team 1</p>
            <ul id="team1" style="overflow:hidden">
            </ul>
            <div id="buttonTeam1" class="button" onClick="goToTeam2()">Valider équipe 1</div>
        </div>
        <div style="float:left">
            <p>Team 2</p>
            <ul id="team2" style="overflow:hidden">
            </ul>
            <div id="buttonTeam2" class="button" onClick="sendMatch()" style="display:none">Valider équipe 2</div>
        </div>
        

        <div style="clear: both; display: none;" id="done">Le match a été enregistré et le classement mis à jour.</div>

        <div class="button" style="clear:both;float:left;margin-top:20px" onclick="window.location='/graphs.html'">
            Voir le classement des joueurs
        </div>

        <script type="text/javascript">
            var teams = { '1': [], '2': []};
            var currentTeam = '1';

            // Simple asynchronous requests to server
            function xhr(method, url, data, callback, errorCB) {
              var req = new XMLHttpRequest()
              req.open(method, url, true);

              req.onload = function(e) {
                if (this.status.toString()[0] === '2') {
                  callback(JSON.parse(this.responseText));
                } else {
                  errorCB(this.status, this.responseText);
                }
              }

              if (method === 'POST') {
                req.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                req.send(JSON.stringify(data));
              } else {
                req.send();
              }
            }

            // Load player list from server into the DOM
            var loadPlayerList = function () {
                xhr('GET', '/playerList', null, function (list) {

                    for (var i = 0; i < list.length; i++) (function (player) {
                        var li = document.createElement('li');
                        li.innerHTML = player.name;
                        li.classList.add('joueur');
                        li.addEventListener('click', function () {
                            addPlayerToCurrentTeam(player);
                            li.classList.add('added');
                        }, false);
                        document.getElementById('joueurs').appendChild(li);
                    })(list[i]);

                }, function (error, data) {
                    // error handling
                    console.log(error, data);
                });
            };

            loadPlayerList();

            // Add player to team
            var addPlayerToCurrentTeam = function (player) {
                // Only add if not already in a team
                if (teams['1'].indexOf(player) === -1 && teams['2'].indexOf(player) === -1) {
                    teams[currentTeam].push(player);
                    refreshTeamsDisplay();
                }
            };

            // Display teams
            var refreshTeamsDisplay = function () {
                for (var i in teams) {
                    var teamList = document.getElementById('team' + i);
                    // Clear list
                    teamList.innerHTML = '';
                    for (var j in teams[i]) {
                        // Add player name to list
                        teamList.innerHTML += '<li>' + teams[i][j].name + '</li>';
                    }
                }
            };

            // Validate team
            var goToTeam2 = function () {
                document.getElementById('buttonTeam1').style.display = 'none';
                document.getElementById('buttonTeam2').style.display = 'inline';
                currentTeam = '2';
            };

            // Send match data to server
            var sendMatch = function () {
                var scoreTeam1 = parseInt(window.prompt('Score équipe 1'));
                var scoreTeam2 = parseInt(window.prompt('Score équipe 2'));
                xhr('POST', '/trueskill', {teams: teams, score: {'1': scoreTeam1, '2': scoreTeam2}}, function () {
                    document.getElementById('buttonTeam2').style.display = 'none';
                    document.getElementById('done').style.display = 'block';
                }, function (error, data) {
                    // error handling
                    console.log(error, data);
                });
            };
        </script>

    </body>
</html>